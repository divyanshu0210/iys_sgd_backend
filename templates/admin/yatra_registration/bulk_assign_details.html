{% extends "admin/base_site.html" %}
{% load static %}

{% block content %}
<h1>Bulk Assign Yatra Details</h1>

<form method="get">
    <label>Select Yatra:</label>
    <select name="yatra" onchange="this.form.submit()">
        <option value="">-- Select --</option>
        {% for y in yatras %}
            <option value="{{ y.id }}" {% if y.id|stringformat:"s" == request.GET.yatra %}selected{% endif %}>
                {{ y.title }}
            </option>
        {% endfor %}
    </select>
</form>

{% if registrations %}
<hr>

<form method="post">
    {% csrf_token %}

    <table class="adminlist" style="width:100%;border-collapse:collapse;">
        <thead>
            <tr>
                <th>Profile</th>
                <th>Journey</th>
                <th>Journey Fields</th>
                <th>Accommodation</th>
                <th>Accommodation Fields</th>
            </tr>
        </thead>

        <tbody>
        {% for r in registrations %}
            <tr>
                <!-- Profile Info -->
                <td>
                    <strong>{{ r.profile.first_name }}{{r.profile.last_name }}</strong><br>
                    {{ r.profile.mobile }}
                    <input type="hidden" name="registration_ids" value="{{ r.id }}">
                </td>

                <!-- Journey Section -->
                <td>
                    <div class="journey-container" id="journey-box-{{ r.id }}">
                        <div class="journey-row">
                            <select name="journey_{{ r.id }}[]">
                                <option value="">-- Select --</option>
                                {% for j in journeys %}
                                    <option value="{{ j.id }}">{{ j.title }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="button add-journey" data-profile="{{ r.id }}">
                                + Add
                            </button>
                        </div>
                    </div>
                </td>

                <!-- Journey Fields -->
                <td>
                    <div id="journey-fields-{{ r.id }}">
                        <!-- Auto-added via JS -->
                    </div>
                </td>

                <!-- Accommodation Section -->
                <td>
                    <div class="accommodation-container" id="accommodation-box-{{ r.id }}">
                        <div class="accommodation-row">
                            <select name="accommodation_{{ r.id }}[]">
                                <option value="">-- Select --</option>
                                {% for a in accommodations %}
                                    <option value="{{ a.id }}">{{ a.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="button add-accommodation" data-profile="{{ r.id }}">
                                + Add
                            </button>
                        </div>
                    </div>
                </td>

                <!-- Accommodation Fields -->
                <td>
                    <div id="accommodation-fields-{{ r.id }}">
                        <!-- Auto-added via JS -->
                    </div>
                </td>

            </tr>
        {% endfor %}
        </tbody>
    </table>

    <hr>

    <button type="submit" class="button button-primary">Save Bulk Assignment</button>
</form>

{% endif %}

<style>
td { vertical-align: top; padding: 8px; }
.adminlist th, .adminlist td { border:1px solid #ccc; }
</style>

<script>
// Add extra Journey dropdown
document.querySelectorAll(".add-journey").forEach(btn => {
    btn.addEventListener("click", () => {
        const pid = btn.dataset.profile;
        const container = document.getElementById(`journey-box-${pid}`);

        const clone = container.querySelector(".journey-row").cloneNode(true);
        clone.querySelector("button").remove(); // remove +Add for clones
        container.appendChild(clone);

        // Add journey-specific fields
        const fieldsBox = document.getElementById(`journey-fields-${pid}`);
        const field = document.createElement("input");
        field.type = "text";
        field.name = `seat_number_${pid}[]`;
        field.placeholder = "Seat number";
        fieldsBox.appendChild(field);
    });
});

// Add extra Accommodation dropdown
document.querySelectorAll(".add-accommodation").forEach(btn => {
    btn.addEventListener("click", () => {
        const pid = btn.dataset.profile;
        const container = document.getElementById(`accommodation-box-${pid}`);

        const clone = container.querySelector(".accommodation-row").cloneNode(true);
        clone.querySelector("button").remove(); 
        container.appendChild(clone);

        // Add room field
        const fieldsBox = document.getElementById(`accommodation-fields-${pid}`);
        const field = document.createElement("input");
        field.type = "text";
        field.name = `room_number_${pid}[]`;
        field.placeholder = "Room number";
        fieldsBox.appendChild(field);
    });
});
</script>

{% endblock %}
